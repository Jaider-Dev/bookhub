<div class="dashboard-container">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Lector</h2>
    </div>

    <nav class="sidebar-nav">
      <button 
        [class.active]="selectedSection === 'home'"
        (click)="selectSection('home')"
        class="nav-item">
        Inicio
      </button>
      <button 
        [class.active]="selectedSection === 'inventario'"
        (click)="selectSection('inventario')"
        class="nav-item">
        Explorar Libros
      </button>
      <button 
        [class.active]="selectedSection === 'mis-prestamos'"
        (click)="selectSection('mis-prestamos')"
        class="nav-item">
        Mis Pr√©stamos
      </button>
      <button 
        [class.active]="selectedSection === 'perfil'"
        (click)="selectSection('perfil')"
        class="nav-item">
        Mi Perfil
      </button>
    </nav>

    <div class="sidebar-footer">
      <button (click)="logout()" class="logout-btn">
        Cerrar Sesi√≥n
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <!-- Mensajes -->
    <div *ngIf="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
      <button (click)="clearMessages()" class="close-alert">√ó</button>
    </div>

    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
      <button (click)="clearMessages()" class="close-alert">√ó</button>
    </div>

    <!-- SECCI√ìN: INICIO -->
    <section *ngIf="selectedSection === 'home'" class="content-section">
      <div class="welcome-card">
        <h1>¬°Bienvenido, {{ usuarioActual?.nombre || 'Lector' }}!</h1>
        <p class="subtitle">Explora nuestro cat√°logo de libros y solicita pr√©stamos</p>

        <div class="info-grid">
          <div class="info-card">
            <h3>Libros Disponibles</h3>
            <p>Explora nuestro amplio cat√°logo de libros</p>
            <button (click)="selectSection('inventario')" class="btn-primary">
              Ver Cat√°logo
            </button>
          </div>

          <div class="info-card">
            <h3>Mis Pr√©stamos</h3>
            <p>Consulta el estado de tus pr√©stamos activos</p>
            <button (click)="selectSection('mis-prestamos')" class="btn-primary">
              Ver Pr√©stamos
            </button>
          </div>

          <div class="info-card">
            <h3>Mi Perfil</h3>
            <p>Actualiza tu informaci√≥n personal y contrase√±a</p>
            <button (click)="selectSection('perfil')" class="btn-primary">
              Editar Perfil
            </button>
          </div>
        </div>

        <div class="info-section">
          <h2>Informaci√≥n Importante</h2>
          <ul>
            <li>Los pr√©stamos tienen un per√≠odo de duraci√≥n determinado</li>
            <li>Si excedes la fecha de devoluci√≥n, el acceso se puede suspender</li>
            <li>Solo puedes solicitar pr√©stamos, no hacer devoluciones</li>
            <li>Contacta con el administrador para devoluciones</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN: EXPLORAR LIBROS -->
    <section *ngIf="selectedSection === 'inventario'" class="content-section">
      <h2>Explorar Libros</h2>

      <div class="search-box">
        <input 
          type="text" 
          placeholder="Buscar por t√≠tulo, autor o categor√≠a..."
          (input)="searchLibros = $any($event.target).value; applyLibroFilters()"
          class="search-input">
      </div>

      <div *ngIf="isLoading" class="loading">
        <div class="spinner"></div>
        <p>Cargando libros...</p>
      </div>

      <div *ngIf="!isLoading && librosFiltered.length > 0" class="libros-grid">
        <div *ngFor="let libro of librosFiltered" class="libro-card">
          <div class="libro-header">
            <h3>{{ libro.titulo }}</h3>
            <span class="categoria-badge">{{ libro.categoria }}</span>
          </div>
          <p class="autor">üë§ {{ libro.autor }}</p>
          <p class="ejemplares">üìö Ejemplares: {{ libro.ejemplares }}</p>
          
          <button 
            *ngIf="libro.ejemplares > 0"
            (click)="openPrestamoForm(libro.id!)"
            class="btn-primary">
            üì§ Solicitar Pr√©stamo
          </button>
          <button 
            *ngIf="libro.ejemplares === 0"
            disabled
            class="btn-disabled">
            ‚ùå No disponible
          </button>
        </div>
      </div>

      <div *ngIf="!isLoading && librosFiltered.length === 0 && libros.length > 0" class="empty-state">
        <p>No hay libros que coincidan con tu b√∫squeda</p>
      </div>

      <div *ngIf="!isLoading && libros.length === 0" class="empty-state">
        <p>No hay libros disponibles en el cat√°logo</p>
      </div>
    </section>

    <!-- SECCI√ìN: MIS PR√âSTAMOS -->
    <section *ngIf="selectedSection === 'mis-prestamos'" class="content-section">
      <h2>Mis Pr√©stamos</h2>

      <div *ngIf="isLoading" class="loading">
        <div class="spinner"></div>
        <p>Cargando mis pr√©stamos...</p>
      </div>

      <div *ngIf="!isLoading && misPrestamos.length > 0" class="prestamos-table">
        <table>
          <thead>
            <tr>
              <th>Libro</th>
              <th>Email Usuario</th>
              <th>Fecha Pr√©stamo</th>
              <th>Fecha Devoluci√≥n</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prestamo of misPrestamos">
              <td>{{ prestamo.libroTitulo }}</td>
              <td>{{ prestamo.usuarioEmail }}</td>
              <td>{{ prestamo.fechaPrestamo | date: 'dd/MM/yyyy' }}</td>
              <td>{{ prestamo.fechaDevolucion ? (prestamo.fechaDevolucion | date: 'dd/MM/yyyy') : '‚Äî' }}</td>
              <td>
                <span [class.badge-active]="prestamo.estado === 'ACTIVO'"
                      [class.badge-devuelto]="prestamo.estado === 'DEVUELTO'"
                      [class.badge-vencido]="prestamo.estado === 'VENCIDO'"
                      class="badge">
                  {{ prestamo.estado }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!isLoading && misPrestamos.length === 0" class="empty-state">
        <p>No tienes pr√©stamos registrados</p>
      </div>
    </section>

    <!-- SECCI√ìN: MI PERFIL -->
    <section *ngIf="selectedSection === 'perfil'" class="content-section">
      <app-user-profile></app-user-profile>
    </section>
  </main>
</div>

<!-- MODAL: SOLICITAR PR√âSTAMO -->
<div *ngIf="showPrestamoForm" class="modal-overlay" (click)="closePrestamoForm()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Solicitar Pr√©stamo</h3>
      <button (click)="closePrestamoForm()" class="close-btn">√ó</button>
    </div>
    <div class="modal-body">
      <div *ngIf="ejemplaresForSelectedLibro.length > 0">
        <label for="ejemplarSelect">Seleccione el ejemplar disponible</label>
        <select id="ejemplarSelect" [(ngModel)]="selectedEjemplarId" class="select-ejemplar">
          <option [ngValue]="null">-- Seleccione --</option>
          <option *ngFor="let ej of ejemplaresForSelectedLibro" [ngValue]="ej.id">Ejemplar #{{ ej.id }}</option>
        </select>
      </div>

      <div *ngIf="ejemplaresForSelectedLibro.length === 0">
        <p>No hay ejemplares disponibles para este libro.</p>
      </div>

      <div class="modal-footer">
        <button (click)="closePrestamoForm()" class="btn-secondary">Cancelar</button>
        <button (click)="createPrestamo()" class="btn-primary">Confirmar Pr√©stamo</button>
      </div>
    </div>
  </div>
</div>